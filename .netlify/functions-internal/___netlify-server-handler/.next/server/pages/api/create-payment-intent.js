"use strict";(()=>{var e={};e.id=144,e.ids=[144],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6090:e=>{e.exports=import("stripe")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},8599:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{config:()=>d,default:()=>l,routeModule:()=>u});var n=i(1802),o=i(7153),a=i(6249),s=i(6376),c=e([s]);s=(c.then?(await c)():c)[0];let l=(0,a.l)(s,"default"),d=(0,a.l)(s,"config"),u=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/create-payment-intent",pathname:"/api/create-payment-intent",bundlePath:"",filename:""},userland:s});r()}catch(e){r(e)}})},3951:(e,t,i)=>{i.d(t,{C:()=>u,i:()=>d});let r=require("firebase-admin"),n=require("path");var o=i.n(n);let a=require("fs");var s=i.n(a);let c="firebase-service-account.json";if(!global._firebaseAdminApp){if(c)try{let e=o().join(process.cwd(),c);if(s().existsSync(e)){let t=s().readFileSync(e,"utf8"),i=JSON.parse(t),n=["project_id","private_key","client_email"].filter(e=>!i[e]);n.length>0?console.error(`Service account JSON missing required fields: ${n.join(", ")}`):(global._firebaseAdminApp=r.initializeApp({credential:r.credential.cert(i)}),console.log("Firebase Admin SDK initialized successfully (via globalThis). Once."),console.log("Initialized Firebase App instance:",global._firebaseAdminApp.name),console.log("Project ID:",i.project_id))}else console.error(`Firebase service account file not found at: ${e}`),console.error("Please ensure the file exists and the path is correct.")}catch(e){throw console.error("Firebase admin initialization error:",e),console.error("Please check:"),console.error("1. The service account JSON file is valid"),console.error("2. The service account has proper permissions"),console.error("3. The FIREBASE_ADMIN_SDK_PATH is correct"),Error("Failed to initialize Firebase Admin SDK. Check FIREBASE_ADMIN_SDK_PATH and file content.")}else console.error("Firebase Admin SDK path is missing. Admin SDK will not be initialized."),console.error("Please set FIREBASE_ADMIN_SDK_PATH in your .env.local file")}let l=global._firebaseAdminApp;l||console.error("Admin SDK failed to initialize. Exported functions will not work.");let d=l?l.firestore():null,u=l?l.auth():null;d&&console.log("adminDb initialized. Project ID:",l?.options.projectId),u&&console.log("adminAuth initialized.")},6376:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{default:()=>s});var n=i(6090),o=i(3951),a=e([n]);let c=new(n=(a.then?(await a)():a)[0]).default(process.env.STRIPE_SECRET_KEY||"",{apiVersion:"2025-10-29.clover"});async function s(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let i;let{amount:r,currency:n="usd",description:a,metadata:s,successUrl:l,cancelUrl:d}=e.body;if(!r||r<=0)return t.status(400).json({error:"Invalid amount"});let u=s?.to,p=s?.recipientUserId;if(p&&o.i)try{let e=o.i.collection("users").doc(p),t=await e.get();if(t.exists){let e=t.data();e?.stripeAccountId&&e?.stripeAccountStatus==="active"&&(i=e.stripeAccountId)}}catch(e){console.error("Error fetching recipient account:",e)}if(!i&&u&&o.i)try{let e=await o.i.collection("users").where("name","==",u).limit(1).get();if(!e.empty){let t=e.docs[0].data();t?.stripeAccountId&&t?.stripeAccountStatus==="active"&&(i=t.stripeAccountId)}}catch(e){console.error("Error finding user by name:",e)}let f={payment_method_types:["card"],line_items:[{price_data:{currency:n,product_data:{name:a||"SquareUp Expense Payment"},unit_amount:Math.round(100*r)},quantity:1}],mode:"payment",success_url:l||`${e.headers.origin||"http://localhost:3000"}/?payment=success`,cancel_url:d||`${e.headers.origin||"http://localhost:3000"}/?payment=cancelled`,metadata:s||{}};i&&(f.payment_intent_data={application_fee_amount:Math.round(100*r*.029+30),on_behalf_of:i,transfer_data:{destination:i}});let m=await c.checkout.sessions.create(f);t.status(200).json({sessionId:m.id,url:m.url,connectedAccountId:i||null,recipientHasAccount:!!i})}catch(e){console.error("Stripe error:",e),t.status(500).json({error:e.message||"Payment processing failed"})}}r()}catch(e){r(e)}})},7153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,t,i)=>{e.exports=i(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var i=t(t.s=8599);module.exports=i})();