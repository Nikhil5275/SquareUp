"use strict";(()=>{var e={};e.id=358,e.ids=[358],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6555:e=>{e.exports=import("uuid")},6249:(e,i)=>{Object.defineProperty(i,"l",{enumerable:!0,get:function(){return function e(i,t){return t in i?i[t]:"then"in i&&"function"==typeof i.then?i.then(i=>e(i,t)):"function"==typeof i&&"default"===t?i:void 0}}})},6498:(e,i,t)=>{t.a(e,async(e,o)=>{try{t.r(i),t.d(i,{config:()=>d,default:()=>c,routeModule:()=>u});var r=t(1802),n=t(7153),s=t(6249),a=t(7054),l=e([a]);a=(l.then?(await l)():l)[0];let c=(0,s.l)(a,"default"),d=(0,s.l)(a,"config"),u=new r.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/generate-invite-token",pathname:"/api/generate-invite-token",bundlePath:"",filename:""},userland:a});o()}catch(e){o(e)}})},3951:(e,i,t)=>{t.d(i,{C:()=>u,i:()=>d});let o=require("firebase-admin"),r=require("path");var n=t.n(r);let s=require("fs");var a=t.n(s);let l="firebase-service-account.json";if(!global._firebaseAdminApp){if(l)try{let e=n().join(process.cwd(),l);if(a().existsSync(e)){let i=a().readFileSync(e,"utf8"),t=JSON.parse(i),r=["project_id","private_key","client_email"].filter(e=>!t[e]);r.length>0?console.error(`Service account JSON missing required fields: ${r.join(", ")}`):(global._firebaseAdminApp=o.initializeApp({credential:o.credential.cert(t)}),console.log("Firebase Admin SDK initialized successfully (via globalThis). Once."),console.log("Initialized Firebase App instance:",global._firebaseAdminApp.name),console.log("Project ID:",t.project_id))}else console.error(`Firebase service account file not found at: ${e}`),console.error("Please ensure the file exists and the path is correct.")}catch(e){throw console.error("Firebase admin initialization error:",e),console.error("Please check:"),console.error("1. The service account JSON file is valid"),console.error("2. The service account has proper permissions"),console.error("3. The FIREBASE_ADMIN_SDK_PATH is correct"),Error("Failed to initialize Firebase Admin SDK. Check FIREBASE_ADMIN_SDK_PATH and file content.")}else console.error("Firebase Admin SDK path is missing. Admin SDK will not be initialized."),console.error("Please set FIREBASE_ADMIN_SDK_PATH in your .env.local file")}let c=global._firebaseAdminApp;c||console.error("Admin SDK failed to initialize. Exported functions will not work.");let d=c?c.firestore():null,u=c?c.auth():null;d&&console.log("adminDb initialized. Project ID:",c?.options.projectId),u&&console.log("adminAuth initialized.")},7054:(e,i,t)=>{t.a(e,async(e,o)=>{try{t.r(i),t.d(i,{default:()=>a});var r=t(6555),n=t(3951),s=e([r]);async function a(e,i){if("POST"===e.method){let{invitedEmail:t,serverId:o,serverName:s,senderName:a}=e.body,l=e.headers.authorization;if(!l||!l.startsWith("Bearer "))return i.status(401).json({message:"Authorization header missing or invalid."});let c=l.split("Bearer ")[1];if(!t||!o||!s||!a)return i.status(400).json({message:"Missing required fields"});console.log("API Route: Received request to generate invite token."),console.log("API Route: Checking adminAuth and adminDb initialization.");try{let e;if(!n.C||!n.i)return console.error("API Route Error: Firebase Admin SDK components are not initialized. adminAuth: ",!!n.C,", adminDb: ",!!n.i),i.status(500).json({message:"Firebase Admin SDK not initialized. Please check service account configuration.",error:"Firebase Admin SDK not initialized"});console.log("API Route: adminAuth and adminDb are initialized.");try{e=await n.C.verifyIdToken(c),console.log("API Route: ID Token verified. Sender UID:",e.uid)}catch(e){return console.error("API Route: ID Token verification failed:",e),i.status(401).json({message:"Invalid authentication token.",error:e.message})}let l=(0,r.v4)(),d=Date.now()+6048e5,u=n.i.collection("invitations").doc(l);console.log("API Route: Attempting to write invitation to Firestore...");try{console.log("API Route: Attempting to write invitation to Firestore..."),await u.set({token:l,invitedEmail:t,serverId:o,serverName:s,senderName:a,senderId:e.uid,createdAt:Date.now(),expiresAt:d,used:!1}),console.log("API Route: Invitation document successfully set in Firestore.")}catch(e){if(console.error("API Route: Firestore write failed:",e),console.error("API Route: Error details:",{code:e.code,details:e.details,metadata:e.metadata,message:e.message}),16===e.code)return i.status(500).json({message:"Firebase service account authentication failed. Please check service account permissions.",error:"Service account authentication error. Ensure the service account has Firestore access.",details:"Go to Firebase Console > Project Settings > Service Accounts and verify permissions."});if(7===e.code)return i.status(500).json({message:"Firestore permission denied. Service account lacks required permissions.",error:e.message});return i.status(500).json({message:"Failed to save invitation to database.",error:e.message})}let m=`http://localhost:3000/join?token=${l}`;i.status(200).json({message:"Invitation token generated",inviteLink:m,token:l})}catch(e){if(console.error("Error generating invite token:",e),e&&"object"==typeof e&&"code"in e&&"auth/argument-error"===e.code)return i.status(401).json({message:"Invalid ID token.",error:e.message});i.status(500).json({message:"Failed to generate invitation token",error:e.message})}}else i.setHeader("Allow",["POST"]),i.status(405).end(`Method ${e.method} Not Allowed`)}r=(s.then?(await s)():s)[0],o()}catch(e){o(e)}})},7153:(e,i)=>{var t;Object.defineProperty(i,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,i,t)=>{e.exports=t(145)}};var i=require("../../webpack-api-runtime.js");i.C(e);var t=i(i.s=6498);module.exports=t})();